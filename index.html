<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Roulette Pro - Session Save</title>
    <style>
        body { background: #004d26; color: white; font-family: Arial, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        
        /* CONTROLLI */
        .controls { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid gold; text-align: center; width: 95%; max-width: 800px; }
        select { padding: 8px; font-weight: bold; border-radius: 4px; background: #eee; }
        .status-info { margin-top: 5px; font-size: 13px; color: #ffeb3b; text-transform: uppercase; }

        /* TAVOLO (Ridimensionato per Mobile) */
        .tavolo { display: grid; grid-template-columns: 45px repeat(12, 35px); grid-template-rows: repeat(3, 35px); gap: 1px; background: #fff; border: 1px solid gold; }
        .cell { background: #006633; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 1px solid #005522; font-size: 14px; }
        .zero-main { grid-row: 1 / span 3; background: #28a745; }
        .red { background: #e61919; } .black { background: #1a1a1a; }

        #history { width: 95%; max-width: 800px; min-height: 30px; background: #000; margin: 10px 0; display: flex; align-items: center; padding: 5px 10px; color: gold; border: 1px solid #bc9a5b; font-size: 12px; word-break: break-all; }

        /* RACETRACK */
        .racetrack { 
            display: grid; 
            grid-template-columns: 40px repeat(15, 40px) 40px; 
            grid-template-rows: repeat(6, 40px); 
            gap: 1px; background: #111; padding: 5px; border: 2px solid #444;
            transform: scale(0.9); /* Aiuta la visualizzazione su schermi piccoli */
        }
        .slot { border: 1px solid #555; display: flex; flex-direction: column; background: #222; }
        .val { height: 18px; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; }
        .num { flex-grow: 1; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: #fff; }
        .slot-zero { grid-row: span 2; }
        .slot-zero .val { height: 36px; }

        /* HEATMAP */
        .h0 { background-color: #ffffff !important; }
        .h1 { background-color: #ffcccc !important; }
        .h2 { background-color: #ff6666 !important; }
        .h3 { background-color: #ff0000 !important; color: #fff !important; }
        .predicted { outline: 2px solid #00ff00; z-index: 10; box-shadow: 0 0 10px #00ff00; }

        .btn-reset { margin-top: 10px; padding: 10px 20px; background: #bc9a5b; border: none; font-weight: bold; border-radius: 4px; color: black; }
    </style>
</head>
<body>

    <div class="controls">
        <select id="mode-select" onchange="changeMode()">
            <option value="ccw">1) Solo Antiorario</option>
            <option value="cw">2) Solo Orario</option>
            <option value="alt">3) Alternata (Orario/Antiorario)</option>
        </select>
        <div id="next-launch" class="status-info">In attesa...</div>
    </div>

    <div class="tavolo" id="tavolo">
        <div class="cell zero-main" onclick="addNum(0)">0</div>
    </div>

    <div id="history">Storico: </div>

    <div class="racetrack" id="ruota"></div>

    <button class="btn-reset" onclick="reset()">RESET TOTALE (Pulisce Memoria)</button>

<script>
    const wheel = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    const reds = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
    
    let history = []; 
    let distCW = [];  
    let distCCW = []; 

    // --- LOGICA DI SALVATAGGIO ---
    function saveToStorage() {
        const data = {
            history: history,
            distCW: distCW,
            distCCW: distCCW,
            mode: document.getElementById('mode-select').value
        };
        localStorage.setItem('rouletteData', JSON.stringify(data));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem('rouletteData');
        if (saved) {
            const data = JSON.parse(saved);
            history = data.history || [];
            distCW = data.distCW || [];
            distCCW = data.distCCW || [];
            document.getElementById('mode-select').value = data.mode || 'ccw';
            updateUI();
        }
    }

    // Inizializza Tavolo
    const tav = document.getElementById('tavolo');
    for(let c=1; c<=12; c++) {
        for(let r=3; r>=1; r--) {
            let n = (c-1)*3 + r;
            let d = document.createElement('div');
            d.className = `cell ${reds.includes(n)?'red':'black'}`;
            d.style.gridColumn = c + 1;
            d.style.gridRow = 4 - r;
            d.innerText = n;
            d.onclick = () => addNum(n);
            tav.appendChild(d);
        }
    }

    function buildWheel() {
        const ruotaDiv = document.getElementById('ruota');
        ruotaDiv.innerHTML = '';
        const path = [
            {n: 5, r: 1, c: 2}, {n: 24, r: 1, c: 3}, {n: 16, r: 1, c: 4}, {n: 33, r: 1, c: 5}, {n: 1, r: 1, c: 6}, 
            {n: 20, r: 1, c: 7}, {n: 14, r: 1, c: 8}, {n: 31, r: 1, c: 9}, {n: 9, r: 1, c: 10}, {n: 22, r: 1, c: 11}, 
            {n: 18, r: 1, c: 12}, {n: 29, r: 1, c: 13}, {n: 7, r: 1, c: 14}, {n: 28, r: 1, c: 15}, {n: 12, r: 1, c: 16},
            {n: 35, r: 2, c: 17}, {n: 3, r: 3, c: 17}, {n: 26, r: 4, c: 17}, {n: 0, r: 5, c: 17, special: 'zero'},
            {n: 32, r: 6, c: 16}, {n: 15, r: 6, c: 15}, {n: 19, r: 6, c: 14}, {n: 4, r: 6, c: 13}, {n: 21, r: 6, c: 12}, 
            {n: 2, r: 6, c: 11}, {n: 25, r: 6, c: 10}, {n: 17, r: 6, c: 9}, {n: 34, r: 6, c: 8}, {n: 6, r: 6, c: 7}, 
            {n: 27, r: 6, c: 6}, {n: 13, r: 6, c: 5}, {n: 36, r: 6, c: 4}, {n: 11, r: 6, c: 3}, {n: 30, r: 6, c: 2},
            {n: 8, r: 5, c: 1}, {n: 23, r: 4, c: 1}, {n: 10, r: 3, c: 1}
        ];

        path.forEach(item => {
            let s = document.createElement('div');
            s.className = 'slot' + (item.special === 'zero' ? ' slot-zero' : '');
            s.id = `s-${item.n}`;
            s.style.gridRow = `${item.r} / span ${item.special === 'zero' ? 2 : 1}`;
            s.style.gridColumn = item.c;
            s.innerHTML = `<div class="val h0" id="v-${item.n}">0</div>
                           <div class="num" style="background:${item.n===0?'#28a745':reds.includes(item.n)?'#e61919':'#1a1a1a'}">${item.n}</div>`;
            ruotaDiv.appendChild(s);
        });
    }

    function addNum(n) {
        const mode = document.getElementById('mode-select').value;
        const lastBall = history.length > 0 ? history[history.length - 1] : null;

        if (lastBall !== null) {
            let idxPrev = wheel.indexOf(lastBall);
            let idxCurr = wheel.indexOf(n);
            let dCW = (idxCurr - idxPrev + 37) % 37;
            let dCCW = (idxPrev - idxCurr + 37) % 37;

            if (mode === 'ccw') { saveDist(dCCW, 'ccw'); } 
            else if (mode === 'cw') { saveDist(dCW, 'cw'); } 
            else {
                if (history.length % 2 !== 0) { saveDist(dCW, 'cw'); } 
                else { saveDist(dCCW, 'ccw'); }
            }
        }
        history.push(n);
        if (history.length > 20) history.shift();
        
        saveToStorage(); // Salva dopo ogni inserimento
        updateUI();
    }

    function saveDist(d, type) {
        if (type === 'cw') {
            distCW.push(d);
            if (distCW.length > 10) distCW.shift();
        } else {
            distCCW.push(d);
            if (distCCW.length > 10) distCCW.shift();
        }
    }

    function updateUI() {
        const mode = document.getElementById('mode-select').value;
        const status = document.getElementById('next-launch');
        document.getElementById('history').innerText = "Storico: " + history.join(" - ");

        wheel.forEach(num => {
            let v = document.getElementById(`v-${num}`);
            if(v) { v.innerText = "0"; v.className = "val h0"; document.getElementById(`s-${num}`).classList.remove('predicted'); }
        });

        if (history.length < 1) {
            status.innerText = "In attesa...";
            return;
        }

        let lastNum = history[history.length - 1];
        let lastIdx = wheel.indexOf(lastNum);
        let currentDists = [];
        let nextIsCW = true;

        if (mode === 'ccw') { currentDists = distCCW; nextIsCW = false; status.innerText = "PROSSIMO: ANTIORARIO"; } 
        else if (mode === 'cw') { currentDists = distCW; nextIsCW = true; status.innerText = "PROSSIMO: ORARIO"; } 
        else {
            if (history.length % 2 !== 0) { currentDists = distCCW; nextIsCW = false; status.innerText = "PROSSIMO: ANTIORARIO"; } 
            else { currentDists = distCW; nextIsCW = true; status.innerText = "PROSSIMO: ORARIO"; }
        }

        currentDists.forEach(d => {
            let targetIdx = nextIsCW ? (lastIdx + d) % 37 : (lastIdx - d + 37) % 37;
            let targetNum = wheel[targetIdx];
            let vField = document.getElementById(`v-${targetNum}`);
            if (vField) {
                let count = parseInt(vField.innerText) + 1;
                vField.innerText = count;
                vField.className = "val " + (count===1?'h1':count===2?'h2':'h3');
                document.getElementById(`s-${targetNum}`).classList.add('predicted');
            }
        });
    }

    function changeMode() {
        saveToStorage();
        updateUI();
    }

    function reset() {
        if(confirm("Vuoi cancellare tutto lo storico?")) {
            localStorage.removeItem('rouletteData');
            history = []; distCW = []; distCCW = [];
            updateUI();
        }
    }

    buildWheel();
    loadFromStorage(); // Carica i dati all'apertura
</script>
</body>
</html>
